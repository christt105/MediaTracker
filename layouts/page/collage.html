{{ define "main" }}
<script src="https://unpkg.com/html2canvas-pro@1.6.2/dist/html2canvas-pro.min.js"></script>

<div class="collage-wrapper">

    <aside class="collage-controls">
        <h2>ConfiguraciÃ³n Collage</h2>

        <div class="control-group">
            <label>ðŸ“… Desde:</label>
            <input type="date" id="start-date">
        </div>

        <div class="control-group">
            <label>ðŸ“… Hasta:</label>
            <input type="date" id="end-date">
        </div>

        <div class="control-group">
            <label>Tipo:</label>
            <div class="checkbox-wrapper">
                <label><input type="checkbox" value="movie" checked> PelÃ­culas</label>
                <label><input type="checkbox" value="tv" checked> Series</label>
                <label><input type="checkbox" value="videogame" checked> Juegos</label>
            </div>
        </div>

        <div class="control-group">
            <label>Columnas: <span id="col-val">5</span></label>
            <input type="range" id="columns-range" min="2" max="10" value="5">
        </div>

        <div class="control-group">
            <label>Calidad: <span id="quality-val">5</span></label>
            <input type="range" id="quality-range" min="1" max="10" value="5">
        </div>

        <div class="control-stats">
            Items encontrados: <strong id="count-display">0</strong>
        </div>

        <button id="download-btn" class="btn-download">
            <i class="fas fa-download"></i> Descargar PNG
        </button>
    </aside>

    <div class="collage-preview-area">
        <div id="collage-canvas"></div>
    </div>

</div>

<style>
    .collage-wrapper {
        display: flex;
        gap: 30px;
        padding: 20px;
        max-width: 1400px;
        margin: 80px auto 0;
    }

    .collage-controls {
        flex: 0 0 300px;
        background: rgb(59, 59, 59);
        padding: 20px;
        border-radius: 12px;
        height: fit-content;
        position: sticky;
        top: 100px;
    }

    .control-group {
        margin-bottom: 20px;
    }

    .control-group label {
        display: block;
        font-weight: bold;
        margin-bottom: 8px;
    }

    .checkbox-wrapper label {
        display: block;
        font-weight: normal;
        margin-bottom: 5px;
        cursor: pointer;
    }

    input[type="date"],
    input[type="range"] {
        width: 100%;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #ccc;
    }

    .btn-download {
        width: 100%;
        padding: 15px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        cursor: pointer;
        transition: background 0.3s;
    }

    .btn-download:hover {
        opacity: 0.9;
    }

    .collage-preview-area {
        flex: 1;
        background: #333;
        padding: 40px;
        border-radius: 12px;
        overflow: auto;
        display: flex;
        justify-content: center;

        align-items: start;
    }

    #collage-canvas {
        background: black;
        display: grid;
        gap: 0;
        width: fit-content;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        align-content: start;
        height: fit-content;
    }

    .collage-item {
        width: 600px;
        aspect-ratio: 2/3;
        overflow: hidden;
        position: relative;
    }

    .collage-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .collage-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        font-size: 10px;
        padding: 2px;
        text-align: center;
        opacity: 0;
    }
</style>

<script>
    let allMedia = [];

    const canvas = document.getElementById('collage-canvas');
    const startDateInput = document.getElementById('start-date');
    const endDateInput = document.getElementById('end-date');
    const columnsInput = document.getElementById('columns-range');
    const colValDisplay = document.getElementById('col-val');
    const countDisplay = document.getElementById('count-display');
    const qualityInput = document.getElementById('quality-range');
    const qualityValDisplay = document.getElementById('quality-val');

    // Load data
    fetch('{{ "index.json" | relURL }}')
        .then(response => response.json())
        .then(data => {
            allMedia = data;
            console.log("Datos cargados:", allMedia.length);

            // Set current year range by default
            const today = new Date();
            const startOfYear = new Date(today.getFullYear(), 0, 2);
            startDateInput.valueAsDate = startOfYear;
            endDateInput.valueAsDate = today;

            renderCollage();
        });

    function renderCollage() {
        const start = new Date(startDateInput.value);
        const end = new Date(endDateInput.value);

        let columns = parseInt(columnsInput.value);
        const quality = parseInt(qualityInput.value);

        const checkedTypes = Array.from(document.querySelectorAll('.checkbox-wrapper input:checked')).map(cb => cb.value);

        // Make Shows/Season the same filter
        if (checkedTypes.includes("tv")) {
            checkedTypes.push("season");
        }

        const filtered = allMedia.filter(item => {
            if (!checkedTypes.includes(item.type)) return false;

            if (item.date) {
                const itemDate = new Date(item.date);

                const endOfDay = new Date(end);
                endOfDay.setHours(23, 59, 59);

                return itemDate >= start && itemDate <= endOfDay;
            }
            return false;
        });

        if (filtered.length > 0 && filtered.length < columns) {
            columns = filtered.length;
        }

        countDisplay.innerText = filtered.length;
        colValDisplay.innerText = columnsInput.value;

        qualityValDisplay.innerText = qualityInput.value;


        canvas.style.gridTemplateColumns = `repeat(${columns}, 600px)`;
        canvas.innerHTML = '';

        filtered.forEach(item => {
            const div = document.createElement('div');
            div.className = 'collage-item';

            div.innerHTML = `<img src="${item.image}" alt="${item.title}" crossorigin="anonymous">`;
            canvas.appendChild(div);
        });
    }

    // Event Listeners
    [startDateInput, endDateInput, columnsInput, qualityInput].forEach(el => {
        el.addEventListener('change', renderCollage);
        el.addEventListener('input', renderCollage);
    });

    document.querySelectorAll('.checkbox-wrapper input').forEach(el => {
        el.addEventListener('change', renderCollage);
    });

    // Download
    document.getElementById('download-btn').addEventListener('click', () => {
        const btn = document.getElementById('download-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando...';

        const SCALE = Math.max(2, window.devicePixelRatio || 1);

        html2canvas(canvas, {
            useCORS: true,
            scale: SCALE,
            backgroundColor: null,
            onclone: doc => {
                const c = doc.getElementById('collage-canvas');
                c.style.overflow = 'visible';
                c.style.maxWidth = 'none';
            }
        }).then(renderedCanvas => {
            const link = document.createElement('a');
            link.download = `MediaTracker_${new Date().toISOString().slice(0, 10)}.png`;
            link.href = renderedCanvas.toDataURL('image/png');
            link.click();
        });
    });

</script>
{{ end }}