{{ define "main" }}
<script src="https://unpkg.com/html2canvas-pro@1.6.2/dist/html2canvas-pro.min.js"></script>

<div class="collage-wrapper">

    <aside class="collage-controls">
        <h2>ConfiguraciÃ³n Collage</h2>

        <div class="control-group">
            <label>ðŸ“… Desde:</label>
            <input type="date" id="start-date">
        </div>

        <div class="control-group">
            <label>ðŸ“… Hasta:</label>
            <input type="date" id="end-date">
        </div>

        <div class="control-group">
            <label>Tipo:</label>
            <div class="checkbox-wrapper">
                <label><input type="checkbox" value="movie" checked> PelÃ­culas</label>
                <label><input type="checkbox" value="tv" checked> Series</label>
                <label><input type="checkbox" value="videogame" checked> Juegos</label>
            </div>
        </div>

        <div class="control-group">
            <label>Columnas: <span id="col-val">5</span></label>
            <input type="range" id="columns-range" min="2" max="20" value="5">
        </div>

        <div class="control-stats">
            Items encontrados: <strong id="count-display">0</strong>
        </div>

        <button id="download-btn" class="btn-download">
            <i class="fas fa-download"></i> Descargar PNG
        </button>
    </aside>

    <div class="collage-preview-area">
        <div class="canvas-scaler">
            <div id="collage-canvas"></div>
        </div>
    </div>

</div>

<style>
    .collage-wrapper {
        display: flex;
        gap: 30px;
        padding: 20px;
        max-width: 100%;
        margin: 80px auto 0;
        height: calc(100vh - 100px); 
        box-sizing: border-box;
    }

    .collage-controls {
        flex: 0 0 300px;
        background: rgb(59, 59, 59);
        padding: 20px;
        border-radius: 12px;
        height: fit-content;
        overflow-y: auto;
        max-height: 100%;
    }

    .control-group {
        margin-bottom: 20px;
    }

    .control-group label {
        display: block;
        font-weight: bold;
        margin-bottom: 8px;
    }

    .checkbox-wrapper label {
        display: block;
        font-weight: normal;
        margin-bottom: 5px;
        cursor: pointer;
    }

    input[type="date"],
    input[type="range"] {
        width: 100%;
        padding: 8px;
        border-radius: 6px;
        border: 1px solid #ccc;
        box-sizing: border-box;
    }

    .btn-download {
        width: 100%;
        padding: 15px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        cursor: pointer;
        transition: background 0.3s;
    }

    .btn-download:hover {
        opacity: 0.9;
    }

    .collage-preview-area {
        flex: 1;
        background: #333;
        padding: 20px;
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

    .canvas-scaler {
        transform-origin: center center;
        transition: transform 0.3s ease;
    }

    #collage-canvas {
        background: black;
        display: grid;
        gap: 0;
        width: fit-content;
        box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
    }

    .collage-item {
        width: 600px;
        aspect-ratio: 2/3;
        overflow: hidden;
        position: relative;
    }

    .collage-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }
</style>

<script>
    let allMedia = [];

    const canvas = document.getElementById('collage-canvas');
    const scaler = document.querySelector('.canvas-scaler');
    const previewArea = document.querySelector('.collage-preview-area');

    const startDateInput = document.getElementById('start-date');
    const endDateInput = document.getElementById('end-date');
    const columnsInput = document.getElementById('columns-range');
    const colValDisplay = document.getElementById('col-val');
    const countDisplay = document.getElementById('count-display');

    fetch('{{ "index.json" | relURL }}')
        .then(response => response.json())
        .then(data => {
            allMedia = data;
            console.log("Data loaded:", allMedia.length);

            const today = new Date();
            const startOfYear = new Date(today.getFullYear(), 0, 2);
            startDateInput.valueAsDate = startOfYear;
            endDateInput.valueAsDate = today;

            renderCollage();
            
            window.addEventListener('resize', fitPreviewToScreen);
        });

    function renderCollage() {
        const start = new Date(startDateInput.value);
        const end = new Date(endDateInput.value);

        let columns = parseInt(columnsInput.value);

        const checkedTypes = Array.from(document.querySelectorAll('.checkbox-wrapper input:checked')).map(cb => cb.value);

        if (checkedTypes.includes("tv")) {
            checkedTypes.push("season");
        }

        const filtered = allMedia.filter(item => {
            if (!checkedTypes.includes(item.type)) return false;

            if (item.date) {
                const itemDate = new Date(item.date);
                const endOfDay = new Date(end);
                endOfDay.setHours(23, 59, 59);
                return itemDate >= start && itemDate <= endOfDay;
            }
            return false;
        });

        if (filtered.length > 0 && filtered.length < columns) {
            columns = filtered.length;
        }

        countDisplay.innerText = filtered.length;
        colValDisplay.innerText = columnsInput.value;

        canvas.style.gridTemplateColumns = `repeat(${columns}, 600px)`;
        canvas.innerHTML = '';

        filtered.forEach(item => {
            const div = document.createElement('div');
            div.className = 'collage-item';
            div.innerHTML = `<img src="${item.image}" alt="${item.title}" crossorigin="anonymous" loading="eager">`;
            canvas.appendChild(div);
        });

        setTimeout(fitPreviewToScreen, 100);
    }

    function fitPreviewToScreen() {
        if (!canvas.firstChild) return;

        const containerWidth = previewArea.clientWidth - 40; 
        const containerHeight = previewArea.clientHeight - 40;
        
        const contentWidth = canvas.scrollWidth;
        const contentHeight = canvas.scrollHeight;

        const scaleX = containerWidth / contentWidth;
        const scaleY = containerHeight / contentHeight;
        
        let scale = Math.min(scaleX, scaleY);
        
        if (scale > 1) scale = 1;

        scaler.style.transform = `scale(${scale})`;
    }

    [startDateInput, endDateInput, columnsInput].forEach(el => {
        el.addEventListener('change', renderCollage);
        el.addEventListener('input', renderCollage);
    });

    document.querySelectorAll('.checkbox-wrapper input').forEach(el => {
        el.addEventListener('change', renderCollage);
    });

    document.getElementById('download-btn').addEventListener('click', () => {
        const btn = document.getElementById('download-btn');
        const originalText = btn.innerHTML;
        const itemCount = parseInt(countDisplay.innerText);

        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generando...';
        btn.disabled = true;

        const SAFE_SCALE = 1; 

        html2canvas(canvas, {
            useCORS: true,
            allowTaint: true,
            scale: SAFE_SCALE, 
            backgroundColor: null,
            logging: false,
            onclone: (clonedDoc) => {
                const clonedCanvas = clonedDoc.getElementById('collage-canvas');
                const clonedScaler = clonedDoc.querySelector('.canvas-scaler');
                
                if(clonedScaler) {
                    clonedScaler.style.transform = 'none';
                    clonedScaler.style.margin = '0';
                    clonedScaler.style.padding = '0';
                }
                
                clonedCanvas.style.overflow = 'visible';
                clonedCanvas.style.maxWidth = 'none';
                clonedCanvas.style.height = 'auto';
            }
        }).then(renderedCanvas => {
            renderedCanvas.toBlob(function(blob) {
                if (!blob) {
                    alert("Error: Image is too large for the browser.");
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }
                
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.download = `MediaTracker_${new Date().toISOString().slice(0, 10)}.png`;
                link.href = url;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => URL.revokeObjectURL(url), 1000);

                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 'image/png');

        }).catch(err => {
            console.error("Canvas Error:", err);
            btn.innerHTML = 'Error :(';
            setTimeout(() => { 
                btn.innerHTML = originalText; 
                btn.disabled = false;
            }, 2000);
        });
    });
</script>
{{ end }}